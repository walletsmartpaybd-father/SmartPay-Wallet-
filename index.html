<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartPay Wallet - User Panel</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        /* --- 1. Global Styles & Variables --- */
        :root {
            --primary-green: #22c55e;
            --primary-blue: #3b82f6;
            --primary-red: #ef4444;
            --primary-yellow: #f59e0b;
            --text-dark: #1f2937;
            --text-light: #6b7283;
            --bg-light: #f3f4f6;
            --bg-white: #ffffff;
            --border-color: #e5e7eb;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #dbeafe;
            color: var(--text-dark);
        }

        /* --- 2. Mobile Container --- */
        .mobile-container {
            width: 375px;
            height: 812px;
            background-color: var(--bg-white);
            border-radius: 40px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .app-main-content {
            flex-grow: 1;
            overflow-y: auto;
            overflow-x: hidden;
            background-color: #f8fafc;
            padding-bottom: 70px;
        }

        .page {
            display: none; /* Hidden by default */
            flex-direction: column;
            min-height: 100%;
        }

        .page.active {
            display: flex;
        }

        /* --- 3. Reusable Components --- */
        
        .page-header,
        #page-home .home-header {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: var(--bg-white);
        }
        #page-home .home-header {
             background-color: #f8fafc;
        }
        #page-profile .page-header {
            background-color: var(--bg-light);
        }

        .page-header {
            display: flex;
            align-items: center;
            padding: 20px 16px;
            font-size: 1.1rem;
            font-weight: 600;
        }
        .page-header .back-icon {
            font-size: 1.2rem;
            margin-right: 12px;
            cursor: pointer;
        }
        .page-header .title {
            flex-grow: 1;
        }
        .page-header .menu-icon {
            font-size: 1.2rem;
            cursor: pointer;
        }

        .card {
            background: var(--bg-white);
            border-radius: 16px;
            padding: 20px;
            margin: 0 16px 16px 16px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        .btn {
            display: block;
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            color: var(--bg-white);
            cursor: pointer;
            text-align: center;
            text-decoration: none;
        }
        .btn-primary { background-color: var(--primary-green); }
        .btn-secondary { background-color: var(--primary-blue); }
        .btn-red { background-color: var(--primary-red); }
        
        /* [NEW] Style for disabled buttons */
        .btn:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .form-group {
            margin-bottom: 16px;
        }
        .form-group label {
            display: block;
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-light);
        }
        .form-group input,
        .form-group textarea, /* [NEW] */
        .form-group input[type="file"], /* [NEW] */
        .form-group .input-wrapper {
            width: 100%;
            padding: 14px 16px;
            font-size: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            background-color: var(--bg-light);
        }
        
        /* [NEW] Style for file input */
        .form-group input[type="file"] {
            padding: 10px 12px;
            font-size: 0.9rem;
        }
        /* [NEW] Style for textarea */
        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .input-wrapper {
            display: flex;
            align-items: center;
        }
        .input-wrapper input {
            border: none;
            background: none;
            padding: 0;
            margin: 0;
            flex-grow: 1;
            outline: none;
        }
        .input-wrapper i {
            color: var(--text-light);
        }

        .list-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--bg-light);
        }
        .list-item:last-child {
            border-bottom: none;
        }
        .list-item .icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: grid;
            place-items: center;
            margin-right: 12px;
            font-size: 1.1rem;
            /* [NEW] Added for avatar images */
            overflow: hidden;
        }
        .list-item .icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .list-item .icon.deposit { background-color: #dcfce7; color: var(--primary-green); }
        .list-item .icon.withdraw { background-color: #eff6ff; color: var(--primary-blue); }
        
        .list-item .content {
            flex-grow: 1;
        }
        .list-item .content .title {
            font-weight: 600;
        }
        .list-item .content .subtitle {
            font-size: 0.85rem;
            color: var(--text-light);
        }
        .list-item .amount {
            font-weight: 600;
        }
        .list-item .status {
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .status.successful, .status.approved { color: var(--primary-green); }
        .status.pending, .status.processing { color: var(--primary-yellow); }
        .status.rejected, .status.cancelled { color: var(--primary-red); }

        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin: 0 16px 16px 16px;
        }
        .tab-item {
            flex: 1;
            text-align: center;
            padding: 12px 0;
            font-weight: 600;
            color: var(--text-light);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            margin-bottom: -1px;
        }
        .tab-item.active {
            color: var(--primary-green);
            border-bottom-color: var(--primary-green);
        }
        
        .toast {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.9rem;
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
            z-index: 100;
            pointer-events: none;
        }
        .toast.show {
            opacity: 1;
            bottom: 100px;
        }
        
        .confirmation-modal {
            position: absolute;
            bottom: -100%;
            left: 0;
            width: 100%;
            background: var(--bg-white);
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            padding: 24px;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.1);
            transition: bottom 0.4s ease-in-out;
            z-index: 50;
        }
        .confirmation-modal.show {
            bottom: 0;
        }
        .confirmation-modal h3 {
            font-size: 1.2rem;
            margin-bottom: 16px;
            text-align: center;
        }
        .confirmation-modal .detail-item {
            display: flex;
            justify-content: space-between;
            font-size: 0.95rem;
            margin-bottom: 12px;
        }
        .confirmation-modal .detail-item span:first-child {
            color: var(--text-light);
        }
        .confirmation-modal .detail-item span:last-child {
            font-weight: 600;
        }
        .confirmation-modal .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }
        .confirmation-modal .modal-actions .btn {
            flex: 1;
        }
        .confirmation-modal .modal-actions .btn-outline {
            background: var(--bg-light);
            color: var(--text-dark);
        }
        
        #modal-overlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.4);
            z-index: 49;
            transition: opacity 0.3s;
        }

        .success-toast {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-green);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s, top 0.3s;
        }
        .success-toast.show {
            opacity: 1;
            top: 40px;
        }
        
        .error-toast {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-red);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s, top 0.3s;
        }
        .error-toast.show {
            opacity: 1;
            top: 40px;
        }

        /* --- 4. Bottom Navigation --- */
        .bottom-nav {
            display: flex;
            height: 70px;
            background-color: var(--bg-white);
            border-top: 1px solid var(--border-color);
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.03);
            position: fixed;
            bottom: 0;
            width: 375px;
            z-index: 1000;
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: var(--text-light);
            font-size: 0.7rem;
            font-weight: 500;
            cursor: pointer;
            transition: color 0.2s;
            position: relative;
        }
        
        .nav-item i {
            font-size: 1.3rem;
            margin-bottom: 4px;
        }
        .nav-item.active {
            color: var(--primary-blue);
        }
        .nav-item#nav-tasks .nav-icon {
            background: var(--primary-green);
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: grid;
            place-items: center;
            margin-top: -20px;
            box-shadow: 0 -4px 12px rgba(34, 197, 94, 0.3);
        }
        .nav-item#nav-tasks.active .nav-icon {
            background: #1ca553;
        }
        .nav-item#nav-tasks span {
            margin-top: 2px;
        }

        .nav-item .notification-badge {
            position: absolute;
            top: 10px;
            left: 50%;
            margin-left: 8px;
            background: var(--primary-red);
            color: white;
            font-size: 0.7rem;
            font-weight: 600;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: grid;
            place-items: center;
            z-index: 1;
        }

        /* --- 5. Auth Screens --- */
        #auth-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding: 30px;
            overflow-y: auto;
        }
        #auth-container .page {
            flex-grow: 1;
        }
        #auth-container h2 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-top: 40px;
            margin-bottom: 24px;
        }
        #auth-container .auth-footer {
            text-align: center;
            margin-top: 20px;
            font-size: 0.9rem;
        }
        #auth-container .auth-footer a {
            color: var(--primary-green);
            font-weight: 600;
            text-decoration: none;
        }

        /* --- 6. Main App Container --- */
        #app-container {
            display: none; /* Hidden until login */
            flex-direction: column;
            height: 100%;
        }
        
        .restricted-feature {
            opacity: 0.6;
            cursor: not-allowed !important;
            pointer-events: auto !important;
        }


        /* --- 7. Page: Home --- */
        #page-home .home-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 16px;
        }
        #page-home .home-header .menu-icon {
            font-size: 1.5rem;
            color: var(--text-dark);
            cursor: pointer;
        }
        #page-home .home-header .profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid var(--primary-green);
            cursor: pointer;
        }
        
        .verification-prompt {
            display: none;
            margin: -4px 16px 16px 16px;
            padding: 12px;
            border-radius: 12px;
            font-weight: 500;
            justify-content: space-between;
            align-items: center;
        }
        .verification-prompt .btn-verify-action {
            padding: 6px 12px;
            font-size: 0.9rem;
            width: auto;
            color: white;
            text-decoration: none;
            border-radius: 8px;
        }
        
        
        #page-home .balance-card {
            text-align: center;
        }
        #page-home .balance-card .balance-label {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-bottom: 4px;
        }
        #page-home .balance-card .balance-amount {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-dark);
        }
        #page-home .balance-card .balance-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }
        #page-home .balance-card .balance-actions .btn {
            flex: 1;
        }
        
        #page-home .quick-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            padding: 0 16px 16px 16px;
        }
        
        #page-home .stat-card {
            display: flex;
            align-items: center;
            background: var(--bg-white);
            padding: 12px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03);
            overflow: hidden;
        }
        #page-home .stat-card .icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: grid;
            place-items: center;
            font-size: 1.1rem;
            margin-right: 10px;
            flex-shrink: 0;
        }
        .stat-card .icon.pending-withdraw { background-color: #fffbeb; color: #f59e0b; }
        .stat-card .icon.pending-deposit { background-color: #eff6ff; color: #3b82f6; }
        .stat-card .icon.today-income { background-color: #f0fdf4; color: #22c55e; }
        .stat-card .icon.total-bonus { background-color: #f5f3ff; color: #8b5cf6; }
        
        #page-home .stat-card .content .title {
            font-size: 0.8rem;
            color: var(--text-light);
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #page-home .stat-card .content .value {
            font-size: 0.95rem;
            font-weight: 600;
        }

        #page-home .quick-action-row {
            display: flex;
            justify-content: space-around;
            padding: 10px 16px;
        }
        #page-home .action-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            text-decoration: none;
            color: var(--text-dark);
        }
        #page-home .action-item .icon {
            width: 50px;
            height: 50px;
            border-radius: 16px;
            display: grid;
            place-items: center;
            font-size: 1.3rem;
            margin-bottom: 6px;
        }
        #page-home .action-item .label {
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        /* [MODIFIED] Added new colors for quick actions */
        #page-home .action-item .icon.tasks { 
            background-color: #f5f3ff; 
            color: #8b5cf6;
        }
        #page-home .action-item .icon.history { 
            background-color: #fef2f2; 
            color: var(--primary-red); 
        }
        #page-home .action-item .icon.top-up { 
            background-color: #f0fdf4; 
            color: var(--primary-green);
        }
        #page-home .action-item .icon.leaderboard { 
            background-color: #fffbeb; 
            color: var(--primary-yellow);
        }
        /* --- */

        #page-home .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            padding: 10px 16px;
        }
        
        #page-home .new-task-banner {
            background: linear-gradient(90deg, #6366f1, #8b5cf6);
            color: white;
            padding: 12px 16px;
            border-radius: 10px;
            margin: 0 16px;
            font-weight: 600;
            text-align: center;
        }

        #page-home .recent-transactions .list-item .amount.debit {
            color: var(--primary-red);
        }

        /* --- 8. Page: Deposit/Withdraw --- */
        #page-deposit, #page-withdraw {
            background-color: var(--bg-white);
        }
        .fund-page .balance-info {
            padding: 0 16px 16px 16px;
        }
        .fund-page .balance-info .label {
            font-size: 0.9rem;
            color: var(--text-light);
        }
        .fund-page .balance-info .amount {
            font-size: 2rem;
            font-weight: 700;
        }
        .fund-page .balance-info .limits {
            font-size: 0.85rem;
            color: var(--text-light);
        }
        
        .fund-page .form-section {
            padding: 16px;
        }
        .fund-page .section-label {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .fund-page .amount-input-box {
            display: flex;
            align-items: center;
            background: var(--bg-light);
            border-radius: 12px;
            padding: 10px 16px;
        }
        .fund-page .amount-input-box span {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-light);
            margin-right: 8px;
        }
        .fund-page .amount-input-box input {
            flex-grow: 1;
            font-size: 2rem;
            font-weight: 700;
            border: none;
            background: none;
            outline: none;
            width: 100%;
        }
        
        .fund-page .payment-methods {
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        .fund-page .method-card {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .fund-page .method-card.selected {
            border-color: var(--primary-red);
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.2);
        }
        #page-withdraw .method-card.selected {
            border-color: var(--primary-green);
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.2);
        }
        .fund-page .method-card img {
            width: 100%;
            height: 35px;
            object-fit: contain;
        }
        
        .fund-page .submit-button {
            padding: 16px;
            margin-top: auto;
        }
        
        /* --- 9. Page: Refer & Earn (NEW UI) --- */
        #page-refer .refer-header {
            padding: 20px 16px 10px 16px;
        }
        #page-refer .refer-header h2 {
            font-size: 1.8rem;
            font-weight: 700;
        }
        #page-refer .refer-header p {
            font-size: 1.1rem;
            color: var(--text-light);
        }
        
        /* [NEW] স্টাইল: রেফারেল কোড/লিঙ্ক বক্সের জন্য */
        #page-refer .referral-code-box {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-dark);
            text-align: center;
            background: var(--bg-light);
            padding: 16px;
            border-radius: 12px;
            word-break: break-all;
        }

        #page-refer .referral-link-box {
            display: flex;
            background: var(--bg-light);
            border-radius: 12px;
            padding: 6px;
        }
        #page-refer .referral-link-box input {
            flex-grow: 1;
            border: none;
            background: none;
            font-size: 0.9rem;
            padding: 0 10px;
            color: var(--text-dark);
        }
        #page-refer .referral-link-box button {
            border: none;
            background: var(--primary-green);
            color: white;
            padding: 10px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        /* [NEW] স্টাইল: শেয়ার আইকন */
        #page-refer .share-icons {
            display: flex;
            justify-content: space-around;
            padding: 20px 0 0 0;
        }
        #page-refer .share-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--text-dark);
        }
        #page-refer .share-icon i {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: grid;
            place-items: center;
            font-size: 1.8rem;
            color: white;
            margin-bottom: 6px;
        }
        #page-refer .share-icon i.fa-whatsapp { background: #25D366; }
        #page-refer .share-icon i.fa-telegram { background: #0088cc; }
        #page-refer .share-icon i.fa-facebook-messenger { background: #00B2FF; }
        #page-refer .share-icon i.fa-facebook { background: #1877F2; }

        /* [NEW] স্টাইল: স্ট্যাটস কার্ড (আগের মতোই) */
        #page-refer .referral-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        #page-refer .ref-stat-card {
            background: var(--bg-light);
            padding: 16px;
            border-radius: 12px;
        }
        #page-refer .ref-stat-card .label {
            font-size: 0.9rem;
            color: var(--text-light);
        }
        #page-refer .ref-stat-card .value {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        #page-refer .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            padding-bottom: 10px;
        }
        
        /* [MODIFIED] Renamed .recent-invites to .referral-history */
        #page-refer .referral-history .list-item .details .name {
            font-weight: 600;
        }
        #page-refer .referral-history .list-item .details .status-line {
            font-size: 0.9rem;
        }
        /* --- End Page: Refer --- */


        /* --- 10. Page: Notifications --- */
        #page-notifications .notification-list .card {
            display: flex;
            align-items: center;
            padding: 16px;
            margin-bottom: 12px;
        }
        #page-notifications .notification-list .card .icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: grid;
            place-items: center;
            margin-right: 12px;
            font-size: 1.2rem;
        }
        #page-notifications .notification-list .card .icon.success { background-color: #dcfce7; color: #22c55e; }
        #page-notifications .notification-list .card .icon.info { background-color: #eff6ff; color: #3b82f6; }
        
        #page-notifications .notification-list .card .content {
            flex-grow: 1;
        }
        #page-notifications .notification-list .card .content .title {
            font-weight: 600;
        }
        #page-notifications .notification-list .card .content .subtitle {
            font-size: 0.9rem;
            color: var(--text-light);
        }
        #page-notifications .notification-list .card .time {
            font-size: 0.8rem;
            color: var(--text-light);
            align-self: flex-start;
        }

        /* --- 11. Page: Leaderboard --- */
        #page-leaderboard .top-earners {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 16px;
            padding: 20px;
            min-height: 150px; /* [NEW] Added min-height for loading */
        }
        #page-leaderboard .earner-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }
        #page-leaderboard .earner-card .crown {
            position: absolute;
            top: -15px;
            font-size: 1.5rem;
            color: #f59e0b;
        }
        #page-leaderboard .earner-card.rank-2 .crown { color: #a0aec0; }
        #page-leaderboard .earner-card.rank-3 .crown { color: #cd7f32; }
        
        #page-leaderboard .earner-card img {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 3px solid #f59e0b;
        }
        #page-leaderboard .earner-card.rank-2 img { width: 60px; height: 60px; border-color: #a0aec0; }
        #page-leaderboard .earner-card.rank-3 img { width: 60px; height: 60px; border-color: #cd7f32; }

        #page-leaderboard .earner-card .name {
            font-weight: 600;
            margin-top: 6px;
            font-size: 0.9rem; /* [NEW] Adjusted size */
        }
        #page-leaderboard .earner-card .earning {
            font-size: 0.9rem;
            color: var(--text-light);
        }
        
        #page-leaderboard .leaderboard-list .list-item .details {
            flex-grow: 1;
        }
        #page-leaderboard .leaderboard-list .list-item .details .name {
            font-weight: 600;
        }
        #page-leaderboard .leaderboard-list .list-item .details .reward {
            font-size: 0.9rem;
            color: var(--text-light);
        }
        #page-leaderboard .leaderboard-list .list-item .amount-col .total {
            font-weight: 600;
        }
        
        /* [NEW] Leaderboard rank number style */
        #page-leaderboard .leaderboard-list .list-item .rank-number {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-light);
            width: 30px;
            text-align: center;
            margin-right: 10px;
        }

        /* --- 12. Page: Profile --- */
        #page-profile {
            background-color: var(--bg-white);
        }
        #page-profile .profile-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-bottom: 20px;
        }
        #page-profile .profile-header img {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            border: 4px solid var(--bg-white);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-top: -30px;
        }
        #page-profile .profile-header .name {
            font-size: 1.3rem;
            font-weight: 600;
            margin-top: 10px;
        }
        #page-profile .profile-header .status {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            color: var(--primary-yellow);
            font-weight: 500;
        }
        #page-profile .profile-header .status i {
            margin-right: 4px;
        }

        #page-profile .setting-group {
            margin: 0 16px 16px 16px;
        }
        #page-profile .setting-group .group-title {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-light);
            text-transform: uppercase;
            padding: 0 8px 8px 8px;
        }
        #page-profile .setting-card {
            background: var(--bg-light);
            border-radius: 12px;
            padding: 8px 16px;
        }
        #page-profile .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 0;
            font-weight: 500;
            border-bottom: 1px solid #dbeafe;
        }
        #page-profile .setting-item:last-child {
            border-bottom: none;
        }
        #page-profile .setting-item i {
            color: var(--text-light);
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--primary-green);
        }
        input:checked + .slider:before {
            transform: translateX(20px);
        }
        
        #page-profile .verification-banner {
            border-radius: 12px;
            padding: 16px;
            margin: 0 16px 16px 16px;
            background: #fffbeb;
            border: 1px solid #fde047;
            display: none;
        }
        #page-profile .verification-banner .title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.1rem;
            font-weight: 600;
            color: #b45309;
        }
        #page-profile .verification-banner .title i {
            font-size: 1.5rem;
            color: var(--primary-green);
        }
        #page-profile .verification-banner .action {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 12px;
            font-size: 0.9rem;
            color: #b45309;
        }
        #page-profile .verification-banner .action .btn-verify {
            background: var(--primary-green);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 500;
        }
        
        #page-profile .logout-btn {
            margin: 8px 16px;
        }

        /* --- 13. Page: Join Channels --- */
        #page-join-channels .channel-list .card {
            display: flex;
            align-items: center;
            padding: 16px;
            margin-bottom: 12px;
        }
        #page-join-channels .channel-list .card .icon {
            width: 45px;
            height: 45px;
            border-radius: 10px;
            display: grid;
            place-items: center;
            margin-right: 12px;
            font-size: 1.5rem;
            color: white;
        }
        #page-join-channels .card .icon.official { background: var(--primary-blue); }
        #page-join-channels .card .icon.tasks { background: var(--primary-green); }
        
        #page-join-channels .channel-list .card .content {
            flex-grow: 1;
        }
        #page-join-channels .card .content .title {
            font-weight: 600;
        }
        #page-join-channels .card .content .subtitle {
            font-size: 0.9rem;
            color: var(--text-light);
        }
        #page-join-channels .card .btn-join {
            background: var(--primary-blue);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }
        
        /* --- 14. Page: Tasks --- */
        #page-tasks .task-list .card {
            display: flex;
            align-items: center;
            padding: 16px;
            margin-bottom: 12px;
        }
         #page-tasks .task-list .card .icon {
            width: 45px;
            height: 45px;
            border-radius: 10px;
            display: grid;
            place-items: center;
            margin-right: 12px;
            font-size: 1.5rem;
            color: white;
        }
        
        /* [MODIFIED] New task icon styles */
        #page-tasks .card .icon.visit { background: #3b82f6; }
        #page-tasks .card .icon.app-install { background: #8b5cf6; }
        #page-tasks .card .icon.watch-ads { background: #ec4899; }
        
        #page-tasks .task-list .card .content {
            flex-grow: 1;
        }
        #page-tasks .card .content .title {
            font-weight: 600;
        }
        #page-tasks .card .content .reward {
            font-size: 0.9rem;
            color: var(--primary-green);
            font-weight: 500;
        }
        #page-tasks .card .btn-start {
            background: var(--primary-green);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }
        
        /* [NEW] Style for disabled task button */
        #page-tasks .card .btn-start:disabled {
            background: var(--text-light);
            cursor: not-allowed;
        }
        
        /* --- [NEW] 15. Page: Task Detail --- */
        #page-task-detail {
            background-color: var(--bg-white);
        }
        #page-task-detail .task-header {
            padding: 0 16px 16px 16px;
        }
        #page-task-detail .task-header .title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 4px;
        }
        #page-task-detail .task-header .reward {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-green);
        }
        
        #page-task-detail .task-body {
            padding: 16px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        #page-task-detail .instructions-card {
            background: var(--bg-light);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
        }
        #page-task-detail .instructions-card .label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 8px;
        }
        #page-task-detail .instructions-card .instructions-text {
            font-size: 1rem;
            color: var(--text-dark);
        }
        
        #page-task-detail .proof-submission {
            margin-top: auto; /* Pushes to the bottom */
        }
        
        #page-task-detail .btn-visit-task {
            margin-bottom: 16px;
        }


    </style>
</head>
<body>

    <div class="mobile-container">

        <div id="auth-container">
            
            <div class="page active" id="page-create-account">
                <h2>Create Account</h2>
                
                <div class="form-group">
                    <div class="input-wrapper">
                        <input type="text" placeholder="Full Name" id="reg-name">
                        <i class="fa-regular fa-user"></i>
                    </div>
                </div>
                
                <div class="form-group">
                    <div class="input-wrapper">
                        <input type="text" placeholder="Mobile Number (11 Digits)" id="reg-phone" maxlength="11">
                        <i class="fa-solid fa-mobile-screen-button"></i>
                    </div>
                </div>
                
                <div class="form-group">
                    <div class="input-wrapper">
                        <input type="password" placeholder="Create Password (Min 6 chars)" id="reg-pass">
                        <i class="fa-regular fa-eye-slash"></i>
                    </div>
                </div>
                
                <div class="form-group">
                    <div class="input-wrapper">
                        <input type="password" placeholder="Confirm Password" id="reg-confirm-pass">
                        <i class="fa-regular fa-eye-slash"></i>
                    </div>
                </div>

                <div class="form-group">
                    <div class="input-wrapper">
                        <input type="text" placeholder="Referral Code (Optional)" id="reg-referral">
                        <i class="fa-regular fa-clipboard"></i>
                    </div>
                </div>
                
                <a href="#" class="btn btn-primary" style="margin-top: 20px;" id="btn-signup-submit">Sign Up</a>

                <div class="auth-footer">
                    Already have an account? <a href="#" onclick="showAuthPage('page-login')">Login</a>
                </div>
            </div>
            <div class="page" id="page-secure-account"></div>
            
            <div class="page" id="page-login">
                <h2>Welcome Back!</h2>
                
                <div class="form-group">
                    <div class="input-wrapper">
                        <input type="text" placeholder="Mobile Number (11 Digits)" id="login-phone" maxlength="11">
                    </div>
                </div>
                
                <div class="form-group">
                    <div class="input-wrapper">
                        <input type="password" placeholder="Password" id="login-pass">
                    </div>
                </div>
                
                <a href="#" class="btn btn-primary" style="margin-top: 20px;" id="btn-login-submit">Login</a>
                
                <div class="auth-footer">
                    Don't have an account? <a href="#" onclick="showAuthPage('page-create-account')">Sign Up</a>
                </div>
            </div>
            </div>
        <div id="app-container">
            <div class="app-main-content">

                <div class="page active" id="page-home">
                    <div class="home-header">
                        <i class="fa-solid fa-bars menu-icon" onclick="showPage('page-join-channels')"></i>
                        <span style="font-weight: 600; font-size: 1.1rem;">SmartPay Wallet</span>
                        <img src="https://i.pravatar.cc/50?img=1" alt="Profile" class="profile-pic" onclick="showPage('page-profile')">
                    </div>
                    
                    <div class="verification-prompt" id="home-verification-prompt">
                        <span id="prompt-text"></span>
                        <a href="#" id="prompt-action-btn" class="btn-verify-action"></a>
                    </div>
                    <div class="card balance-card">
                        <div class="balance-label">Available Balance:</div>
                        <div class="balance-amount">৳ 0.00</div>
                        <div class="balance-actions">
                            <a href="#" class="btn btn-secondary" onclick="showPage('page-deposit')">Top-up</a>
                            <a href="#" class="btn btn-primary">Withdraw</a>
                        </div>
                    </div>
                    
                    <div class="quick-stats">
                        <div class="stat-card">
                            <div class="icon pending-withdraw"><i class="fa-regular fa-clock"></i></div>
                            <div class="content">
                                <div class="title">Pending Withdraw</div>
                                <div class="value">0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="icon pending-deposit"><i class="fa-solid fa-arrow-down"></i></div>
                            <div class="content">
                                <div class="title">Pending Deposit</div>
                                <div class="value">0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="icon today-income"><i class="fa-solid fa-sack-dollar"></i></div>
                            <div class="content">
                                <div class="title">Today's Income</div>
                                <div class="value">৳ 0.00</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="icon total-bonus"><i class="fa-solid fa-gift"></i></div>
                            <div class="content">
                                <div class="title">Total Bonus</div>
                                <div class="value">৳ 0.00</div>
                            </div>
                        </div>
                    </div>

                    <div class="quick-action-row">
                        <a href="#" class="action-item" onclick="showPage('page-tasks')">
                            <div class="icon tasks"><i class="fa-solid fa-list-check"></i></div>
                            <div class="label">Tasks</div>
                        </a>
                        <a href="#" class="action-item" onclick="showPage('page-history')">
                            <div class="icon history"><i class="fa-solid fa-clock-rotate-left"></i></div>
                            <div class="label">History</div>
                        </a>
                        <a href="#" class="action-item" onclick="showPage('page-deposit')">
                            <div class="icon top-up"><i class="fa-solid fa-wallet"></i></div>
                            <div class="label">Top-up</div>
                        </a>
                        <a href="#" class="action-item" onclick="showPage('page-leaderboard')">
                            <div class="icon leaderboard"><i class="fa-solid fa-trophy"></i></div>
                            <div class="label">Leaderboard</div>
                        </a>
                    </div>
                    
                    <div class="new-task-banner">
                        NEW TASK! Earn More Today
                    </div>

                    <div class="section-title">Recent Transactions</div>
                    <div class="card recent-transactions" id="recent-transactions-home">
                        </div>
                </div>

                <div class="page" id="page-history">
                    <div class="page-header">
                        <i class="fa-solid fa-arrow-left back-icon" onclick="showPage('page-home')"></i>
                        <span class="title">Transaction History</span>
                    </div>

                    <div class="tabs">
                        <div class="tab-item active" data-history-type="all" onclick="switchHistoryTab(this)">All</div>
                        <div class="tab-item" data-history-type="Deposit" onclick="switchHistoryTab(this)">Deposit</div>
                        <div class="tab-item" data-history-type="Withdraw" onclick="switchHistoryTab(this)">Withdraw</div>
                    </div>

                    <div class="history-list card" id="full-history-list">
                        </div>
                </div>
                
                <div class="page fund-page" id="page-deposit">
                    <div class="page-header">
                        <i class="fa-solid fa-arrow-left back-icon" onclick="showPage('page-home')"></i>
                        <span class="title">Deposit Funds</span>
                    </div>

                    <div class="form-section">
                        <div class="section-label">Enter Amount</div>
                        <div class="amount-input-box">
                            <span>৳</span>
                            <input type="number" value="500" placeholder="0" id="deposit-amount">
                        </div>
                        <div class="limits" style="margin-top: 8px;">Min. ৳50, Max. ৳1000</div>
                    </div>
                    
                    <div class="form-section">
                        <div class="section-label">Select Payment (TxID)</div>
                        <div class="payment-methods">
                            </div>
                    </div>

                    <div class="form-section">
                        <div class="form-group">
                            <div class="section-label">Center Number (Send Money to this Number)</div>
                            <div class="input-wrapper" style="background: var(--bg-white);">
                                <input type="text" placeholder="Select a payment method above" id="deposit-destination-number" readonly style="background: var(--bg-light); color: var(--text-dark); font-weight: 600;">
                                <i class="fa-regular fa-copy" onclick="copyToClipboard(document.getElementById('deposit-destination-number').value, 'Number Copied!')" style="cursor: pointer; color: var(--primary-blue); padding-right: 5px;"></i>
                            </div>
                        </div>
                    </div>
                    <div class="form-section">
                        <div class="form-group">
                            <div class="section-label">Sender Mobile Number</div>
                            <div class="input-wrapper" style="background: var(--bg-white);">
                                <input type="text" placeholder="e.g. 01Xx... (11 Digits)" id="deposit-sender-number" maxlength="11">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <div class="section-label">Transaction ID</div>
                            <div class="input-wrapper" style="background: var(--bg-white);">
                                <input type="text" placeholder="Enter Transaction ID (Mandatory)" id="deposit-txid">
                            </div>
                        </div>
                    </div>

                    <div class="submit-button">
                        <a href="#" class="btn" style="background: #e11d48;">Deposit Now</a>
                    </div>
                </div>
                <div class="page fund-page" id="page-withdraw">
                    <div class="page-header">
                        <i class="fa-solid fa-arrow-left back-icon" onclick="showPage('page-home')"></i>
                        <span class="title">Withdraw Funds</span>
                    </div>
                    
                    <div class="balance-info">
                        <div class="label">Available Balance</div>
                        <div class="amount">৳ 0.00</div>
                        <div class="limits">Min. ৳100, Max. Unlimited</div>
                    </div>

                    <div class="form-section">
                        <div class="section-label">Select Payment</div>
                        <div class="payment-methods">
                            </div>
                    </div>
                    
                    <div class="form-section">
                        <div class="form-group">
                            <div class="section-label">Enter Amount</div>
                            <div class="amount-input-box">
                                <span>৳</span>
                                <input type="number" placeholder="0" id="withdraw-amount">
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="section-label">Account Info</div>
                            <div class="input-wrapper" style="background: var(--bg-white);">
                                <input type="text" placeholder="Receiver Account Number (11 Digits)" id="withdraw-receiver-number" maxlength="11">
                            </div>
                        </div>
                    </div>

                    <div class="submit-button">
                        <a href="#" class="btn btn-primary">Send Request</a>
                    </div>
                </div>

                <div class="page" id="page-refer">
                    <div class="page-header" style="padding-bottom: 0;">
                        <i class="fa-solid fa-arrow-left back-icon" onclick="showPage('page-home')"></i>
                        <span class="title">Refer & Earn</span>
                    </div>

                    <div class="refer-header">
                        <h2>Invite Friends,</h2>
                        <p>Earn More!</p>
                    </div>

                    <div class="card">
                        <div class="section-title" style="padding: 0 0 10px 0;">Your Referral Code</div>
                        <div id="referral-code-box" class="referral-code-box">
                            </div>
                    </div>
                    
                    <div class="card">
                        <div class="section-title" style="padding: 0 0 16px 0;">Your Shareable Link</div>
                        <div id="referral-link-container">
                            </div>
                    </div>

                    <div class="card referral-stats">
                        <div class="ref-stat-card">
                            <div class="label">Total Verified Referrals</div>
                            <div class="value" id="referral-stats-count">0</div>
                        </div>
                        <div class="ref-stat-card">
                            <div class="label">Total Referral Income</div>
                            <div class="value" id="referral-stats-income">৳ 0.00</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="ref-stat-card" style="background: none; padding: 0;">
                            <div class="label" style="color: var(--primary-yellow);"><i class="fa-regular fa-clock"></i> Total Referral Processing</div>
                            <div class="value" id="referral-stats-processing" style="color: var(--primary-yellow); padding-top: 4px;">0</div>
                            <div class="label" style="font-size: 0.8rem; padding-top: 2px;">Users not yet verified</div>
                        </div>
                    </div>

                    <div class="card referral-history" id="referral-history-list">
                        <div class="section-title" style="padding: 0 0 10px 0;">Referral History</div>
                        </div>
                </div>
                <div class="page" id="page-notifications">
                    <div class="page-header">
                        <i class="fa-solid fa-arrow-left back-icon" onclick="showPage('page-home')"></i>
                        <span class="title">Notifications</span>
                    </div>

                    <div class="tabs">
                        <div class="tab-item active" onclick="switchTab(this)">Inbox</div>
                        <div class="tab-item" onclick="switchTab(this)">Announcements</div>
                    </div>
                    
                    <div class="notification-list" style="padding: 0 16px;">
                        </div>
                </div>

                <div class="page" id="page-leaderboard">
                    <div class="page-header">
                        <i class="fa-solid fa-arrow-left back-icon" onclick="showPage('page-home')"></i>
                        <span class="title">Leaderboard</span>
                    </div>

                    <div class="tabs">
                        <div class="tab-item active" onclick="switchTab(this)">Leaderboard</div>
                        <div class="tab-item" onclick="switchTab(this)">Badges</div>
                    </div>
                    
                    <div class="section-title" style="padding-top: 0;">Monthly Top Earners</div>
                    
                    <div class="top-earners">
                        </div>

                    <div class="card leaderboard-list">
                        </div>
                </div>

                <div class="page" id="page-profile">
                    <div class="page-header" style="background: var(--bg-light);">
                        <i class="fa-solid fa-arrow-left back-icon" onclick="showPage('page-home')"></i>
                        <span class="title">Profile & Settings</span>
                    </div>
                    <div style="background: var(--bg-light); padding-bottom: 50px;">
                        <div class="profile-header">
                            <img src="https://i.pravatar.cc/100?img=12" alt="Profile">
                            <div class="name">User Name</div>
                            <div class="status"><i class="fa-solid fa-triangle-exclamation"></i> Unverified</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: -30px;">
                        <div class="setting-group">
                            <div class="setting-card">
                                <div class="setting-item">
                                    <span>Mobile Number</span>
                                    <i class="fa-solid fa-chevron-down"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="setting-group">
                            <div class="group-title">Account Settings</div>
                            <div class="setting-card">
                                <div class="setting-item">
                                    <span>Language</span>
                                    <i class="fa-solid fa-chevron-right"></i>
                                </div>
                                <div class="setting-item">
                                    <span>Notifications</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="verification-banner">
                            </div>
                        
                        <a href="#" class="btn btn-red logout-btn">Log Out</a>
                    </div>
                </div>

                <div class="page" id="page-join-channels">
                    <div class="page-header">
                        <i class="fa-solid fa-bars menu-icon" onclick="showPage('page-home')"></i>
                        <span class="title">SmartPay Wallet</span>
                        <img src="https://i.pravatar.cc/50?img=1" alt="Profile" class="profile-pic" style="width: 40px; height: 40px; border: 3px solid var(--primary-green);" onclick="showPage('page-profile')">
                    </div>
                    
                    <h2 style="padding: 10px 16px 16px 16px; font-size: 1.5rem;">Join Channels</h2>
                    
                    <div class="channel-list">
                        </div>
                </div>
                
                <div class="page" id="page-tasks">
                    <div class="page-header">
                        <i class="fa-solid fa-arrow-left back-icon" onclick="showPage('page-home')"></i>
                        <span class="title">Tasks & Income</span>
                    </div>
                    
                    <div class="task-list" style="padding: 0 16px;">
                         </div>
                </div>

                <div class="page" id="page-task-detail">
                    <div class="page-header">
                        <i class="fa-solid fa-arrow-left back-icon" onclick="showPage('page-tasks')"></i>
                        <span class="title">Task Details</span>
                    </div>
                    
                    <div class="task-header">
                        <div class="title" id="task-detail-title">Task Name</div>
                        <div class="reward" id="task-detail-reward">Reward: ৳ 0.00</div>
                    </div>
                    
                    <div class="task-body">
                        <div class="instructions-card">
                            <div class="label">Instructions:</div>
                            <div class="instructions-text" id="task-detail-instructions">
                                Task instructions will appear here.
                            </div>
                        </div>
                        
                        <a href="#" class="btn btn-secondary btn-visit-task" id="task-detail-visit-btn">
                            <i class="fa-solid fa-arrow-up-right-from-square"></i>
                            Visit Link / Start Task
                        </a>
                        
                        <div class="proof-submission">
                            <div class="form-group" id="task-detail-proof-box">
                                </div>
                            <a href="#" class="btn btn-primary" id="task-detail-submit-btn">Submit for Review</a>
                        </div>
                    </div>
                </div>

            </div>

            <nav class="bottom-nav">
                <div class="nav-item active" data-page="page-home" onclick="showPage('page-home')">
                    <i class="fa-solid fa-house"></i>
                    <span>Home</span>
                </div>
                <div class="nav-item" data-page="page-home" onclick="showPage('page-home')"> <i class="fa-solid fa-wallet"></i>
                    <span>Wallet</span>
                </div>
                <div class="nav-item" id="nav-tasks" data-page="page-refer" onclick="showPage('page-refer')">
                    <div class="nav-icon"><i class="fa-solid fa-user-plus"></i></div>
                    <span>Invite</span>
                </div>
                <div class="nav-item" data-page="page-notifications" onclick="showPage('page-notifications')">
                    <i class="fa-regular fa-bell"></i>
                    <span>Notifications</span>
                    <div class="notification-badge" style="display: none;">0</div>
                    </div>
                <div class="nav-item" data-page="page-profile" onclick="showPage('page-profile')">
                    <i class="fa-regular fa-user"></i>
                    <span>Profile</span>
                </div>
            </nav>
            </div>
        
        <div class="toast" id="toast-copied">Copied!</div>
        
        <div class="success-toast" id="success-toast">
            <i class="fa-solid fa-check-circle"></i>
            <span id="success-toast-message">Request Sent Successfully!</span>
        </div>
        
        <div class="error-toast" id="error-toast">
            <i class="fa-solid fa-times-circle"></i>
            <span id="error-toast-message">Error!</span>
        </div>
        
        <div id="modal-overlay"></div>
        <div class="confirmation-modal" id="verification-confirmation-modal">
            </div>

    </div>

    <script>
        // --- 0. Page Navigation ---
        
        const allPages = document.querySelectorAll('.app-main-content .page');
        const navItems = document.querySelectorAll('.bottom-nav .nav-item');
        const authPages = document.querySelectorAll('#auth-container .page');

        // [MODIFIED] Updated showPage to keep Home nav active for sub-pages
        // [MODIFIED] Added renderLeaderboard() call
        function showPage(pageId) {
            allPages.forEach(page => page.classList.remove('active'));
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.add('active');
                document.querySelector('.app-main-content').scrollTop = 0;
            }
            
            // Determine the "root" page for nav highlighting
            let navDataPage = pageId;
            // These pages are accessed from Home, so keep Home active
            if (['page-tasks', 'page-task-detail', 'page-history', 'page-deposit', 'page-withdraw', 'page-leaderboard', 'page-join-channels'].includes(pageId)) {
                navDataPage = 'page-home'; 
            }
            // Special case for the middle button
            if (pageId === 'page-refer') {
                navDataPage = 'page-refer';
            }
            
            navItems.forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-page') === navDataPage) {
                    item.classList.add('active');
                }
            });

            if (pageId === 'page-history') {
                const user = db.getLoggedInUserData();
                if (user) renderHistoryPage(user);
            } else if (pageId === 'page-notifications') {
                renderNotificationPage();
                markNotificationsAsRead();
            } else if (pageId === 'page-tasks') {
                // [NEW] Render tasks when page is shown
                renderTasks();
            } else if (pageId === 'page-leaderboard') {
                // [NEW] Render leaderboard when page is shown
                renderLeaderboard();
            }
        }
        
        function showAuthPage(pageId) {
            authPages.forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
        }

        // --- 1. UI Interactions (Toasts, Modals) ---

        function showToast(message) {
            const toast = document.getElementById('toast-copied');
            toast.innerText = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }
        
        function showSuccessToast(message) {
            const toast = document.getElementById('success-toast');
            document.getElementById('success-toast-message').innerText = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        function showErrorToast(message) {
            const toast = document.getElementById('error-toast');
            document.getElementById('error-toast-message').innerText = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        function switchTab(clickedTab) {
            const tabsContainer = clickedTab.parentElement;
            tabsContainer.querySelectorAll('.tab-item').forEach(tab => {
                tab.classList.remove('active');
            });
            clickedTab.classList.add('active');
        }

        function switchHistoryTab(clickedTab) {
            switchTab(clickedTab);
            const user = db.getLoggedInUserData();
            if (user) {
                renderHistoryPage(user, clickedTab.getAttribute('data-history-type'));
            }
        }

        function selectPayment(clickedMethod) {
            const methodsContainer = clickedMethod.parentElement;
            methodsContainer.querySelectorAll('.method-card').forEach(method => {
                method.classList.remove('selected');
            });
            clickedMethod.classList.add('selected');
        }
        
        // [NEW] FUNCTION TO HANDLE DEPOSIT METHOD SELECTION
        function selectDepositMethod(clickedMethod) {
            // 1. Run the original selection logic
            selectPayment(clickedMethod); 
            
            // 2. Get the destination number from the data attribute
            const destinationNumber = clickedMethod.dataset.methodNumber;
            const destinationInput = document.getElementById('deposit-destination-number');
            
            if (destinationInput) {
                if (destinationNumber && destinationNumber !== 'null') {
                    destinationInput.value = destinationNumber;
                } else {
                    destinationInput.value = '';
                    destinationInput.placeholder = 'No number set for this method.';
                }
            }
        }
        
        /* ================================================================
           [START] JAVASCRIPT LOGIC
           ================================================================ */

        // --- 0. Database Simulation (localStorage) ---
        const db = {
            getUsers: () => JSON.parse(localStorage.getItem('smartpay_users')) || [],
            saveUsers: (users) => localStorage.setItem('smartpay_users', JSON.stringify(users)),
            
            getCurrentUser: () => localStorage.getItem('smartpay_currentUser'),
            setCurrentUser: (phone) => localStorage.setItem('smartpay_currentUser', phone),
            logoutUser: () => localStorage.removeItem('smartpay_currentUser'),
            
            // [START] 3. JS: গ্লোবাল রেফারেল কাউন্টার (Spec 1)
            // Starts checking from 59999, so the first code generated is 60000
            getLastReferralCode: () => JSON.parse(localStorage.getItem('smartpay_lastReferralCode')) || 59999,
            saveLastReferralCode: (code) => localStorage.setItem('smartpay_lastReferralCode', JSON.stringify(code)),
            // [END] 3. JS: গ্লোবাল রেফারেল কাউন্টার
            
            getPendingDeposits: () => JSON.parse(localStorage.getItem('smartpay_pendingDeposits')) || [],
            savePendingDeposits: (deposits) => localStorage.setItem('smartpay_pendingDeposits', JSON.stringify(deposits)),
            
            getPendingWithdrawals: () => JSON.parse(localStorage.getItem('smartpay_pendingWithdrawals')) || [],
            savePendingWithdrawals: (withdrawals) => localStorage.setItem('smartpay_pendingWithdrawals', JSON.stringify(withdrawals)),

            getLoggedInUserData: () => {
                const currentUserPhone = db.getCurrentUser();
                if (!currentUserPhone) return null;
                return db.getUsers().find(u => u.phone === currentUserPhone);
            },
            
            updateLoggedInUserData: (updatedData) => {
                const currentUserPhone = db.getCurrentUser();
                if (!currentUserPhone) return;
                let users = db.getUsers();
                users = users.map(u => u.phone === currentUserPhone ? { ...u, ...updatedData } : u);
                db.saveUsers(users);
            },
            
            getAppSettings: () => JSON.parse(localStorage.getItem('smartpay_appSettings')) || {
                appName: 'SmartPay Wallet',
                homeBannerText: 'NEW TASK! Earn More Today',
                referralBonus: 30, // Default bonus
                verificationCharge: 50 // Default charge
            },
            
            // [MODIFIED] getTasks function to include default tasks
            getTasks: () => {
                const storedTasks = JSON.parse(localStorage.getItem('smartpay_tasks'));
                // Check if tasks are already stored
                if (storedTasks && storedTasks.length > 0) {
                    return storedTasks;
                }
                
                // If no tasks, create and store default tasks based on user images
                const defaultTasks = [
                    { 
                        id: 'task_visit_1', 
                        title: 'Visit Link / Join Task', 
                        instructions: 'Visit the group link, join, and then submit your personal profile link as proof.', 
                        reward: 10, 
                        type: 'visit', // Corresponds to image 1
                        link: 'https://t.me/smartpay_official_channel' // Example link
                    },
                    { 
                        id: 'task_install_1', 
                        title: 'App Install Task', 
                        instructions: 'Click the install button, download the app, open it, and submit a screenshot of the app\'s home screen.', 
                        reward: 20, 
                        type: 'install', // Corresponds to image 2
                        link: 'https://play.google.com/store/apps/details?id=com.google.android.apps.tasks' // Example link
                    },
                    { 
                        id: 'task_watch_1', 
                        title: 'Watch Ad Task', 
                        instructions: 'Click the watch button, watch the entire video ad, and submit the video\'s "Source Link" or "Share Link" as proof.', 
                        reward: 30, 
                        type: 'watch', // Corresponds to image 3
                        link: 'https://www.youtube.com/watch?v=dQw4w9WgXcQ' // Example link
                    }
                ];
                // Save these default tasks to localStorage
                localStorage.setItem('smartpay_tasks', JSON.stringify(defaultTasks));
                return defaultTasks;
            },
            
            getChannels: () => JSON.parse(localStorage.getItem('smartpay_channels')) || [],
            getPaymentMethods: () => JSON.parse(localStorage.getItem('smartpay_paymentMethods')) || [],
            getNotifications: () => JSON.parse(localStorage.getItem('smartpay_notifications')) || [],
            getReadNotifications: () => JSON.parse(localStorage.getItem('smartpay_readNotifications')) || [],
            saveReadNotifications: (readIds) => localStorage.setItem('smartpay_readNotifications', JSON.stringify(readIds)),
            
            // [FIX] Adicionada a função que estava faltando para ler/gravar a fila de tarefas pendentes
            getPendingTaskSubmissions: () => JSON.parse(localStorage.getItem('smartpay_pendingTasks')) || [],
            savePendingTaskSubmissions: (tasks) => localStorage.setItem('smartpay_pendingTasks', JSON.stringify(tasks)),
        };

        // --- 1. App Initialization ---
        function initializeApp() {
            const appSettings = db.getAppSettings();
            
            // Set app name
            document.title = `${appSettings.appName} - User Panel`;
            document.querySelectorAll('.page-header .title, #page-home .home-header span').forEach(el => {
                if (el.innerText.includes('SmartPay Wallet')) el.innerText = appSettings.appName;
            });
            document.querySelector('#page-home .new-task-banner').innerText = appSettings.homeBannerText;
            
            // [START] 4. JS: অটো-ফিল লজিক (Spec 3)
            // This function runs first to capture the URL parameter
            handleReferralAutoFill();
            // [END] 4. JS: অটো-ফিল লজিক

            let currentUser = db.getLoggedInUserData();
            
            if (currentUser) {
                // User is logged in
                document.getElementById('auth-container').style.display = 'none';
                document.getElementById('app-container').style.display = 'flex';
                
                // Render all dynamic data
                renderDynamicData(currentUser, appSettings);
                enforceVerification(currentUser.verificationStatus); 
                renderPaymentMethods();
                renderTasks(); // [MODIFIED] Call renderTasks on init
                renderChannels();
                renderNotificationBadge();
                
                showPage('page-home');
            } else {
                // User is logged out
                document.getElementById('auth-container').style.display = 'flex';
                document.getElementById('app-container').style.display = 'none';
                
                // If auto-fill didn't set the page to register, show login page
                if (!new URLSearchParams(window.location.search).has('ref')) {
                    showAuthPage('page-login');
                }
            }
            
            setupEventListeners();
        }
        
        // --- 2. Auth Flow (Registration & Login) ---
        
        // [START] 5. JS: handleRegistration() (Final Version)
        // [MODIFIED] Added 'submittedTasks: []' to new user object
        function handleRegistration() {
            const name = document.getElementById('reg-name').value;
            const phone = document.getElementById('reg-phone').value;
            const pass = document.getElementById('reg-pass').value;
            const confirmPass = document.getElementById('reg-confirm-pass').value;
            
            // Spec 4: Get the code from the auto-filled box
            const usedReferralCode = document.getElementById('reg-referral').value;

            // --- Validation Flow (Spec 9) ---
            if (!name) { return alert('Please enter your Full Name.'); }
            if (phone.length !== 11 || !/^\d+$/.test(phone)) { return alert('Mobile number must be 11 digits.'); }
            if (pass.length < 6) { return alert('Password must be at least 6 characters.'); }
            if (pass !== confirmPass) { return alert('Password does not match.'); }

            let users = db.getUsers();
            if (users.find(u => u.phone === phone)) { return alert('This phone number is already registered.'); }

            // --- [NEW] Spec 1, 5: Code Generation (Global Counter) ---
            const lastCode = db.getLastReferralCode(); // Get last code (e.g., 59999)
            const newUserCode = lastCode + 1; // New user's code (e.g., 60000)
            db.saveLastReferralCode(newUserCode); // Save new last code (e.g., 60000)
            // --- [END] ---

            // Spec 6: New Data Structure
            const newUser = {
                name: name,
                phone: phone,
                password: pass,
                verificationStatus: 'unverified', // [MODIFIED] Starts as unverified
                balance: 0.0,
                
                referralCode: newUserCode, // This user's OWN code
                referredBy: usedReferralCode || null, // The code they USED to sign up
                referredUsers: [], // List of users they will refer
                
                transactions: [],
                submittedTasks: [], // [NEW] To track submitted task IDs
                
                totalBonus: 0.0,
                todayIncome: 0.0,
                pendingWithdraw: 0,
                pendingDeposit: 0
            };
            
            users.push(newUser);
            
            // --- [NEW] Spec 4, 7: Backend Referral Tracking ---
            if (usedReferralCode) {
                let referrerFound = false;
                users = users.map(u => {
                    // Find the user whose code matches the one used
                    if (u.referralCode && u.referralCode == usedReferralCode) {
                        if (!u.referredUsers) u.referredUsers = [];
                        
                        // Spec 4: Add new user's PHONE (as ID) to referrer's list
                        u.referredUsers.push(newUser.phone); 
                        
                        referrerFound = true;
                    }
                    return u;
                });
                if(referrerFound) console.log(`Referral link successful: ${newUser.phone} was referred by code ${usedReferralCode}`);
            }
            // --- [END] ---
            
            db.saveUsers(users); // 3. Save to database

            // 4. Signup success
            alert("Account created successfully. Please login.");
            showAuthPage('page-login');
            
            // Clear form
            document.getElementById('reg-name').value = '';
            document.getElementById('reg-phone').value = '';
            document.getElementById('reg-pass').value = '';
            document.getElementById('reg-confirm-pass').value = '';
            document.getElementById('reg-referral').value = '';
        }
        // [END] 5. JS: handleRegistration()

        // [START] 6. JS: handleLogin() (Final Version)
        function handleLogin() {
            const phone = document.getElementById('login-phone').value;
            const pass = document.getElementById('login-pass').value;
            
            if (phone.length !== 11 || !/^\d+$/.test(phone)) {
                return alert('Enter a valid 11-digit mobile number.');
            }
            if (!pass) {
                return alert('Please enter your password.');
            }

            const users = db.getUsers();
            const user = users.find(u => u.phone === phone);

            if (user && user.password === pass) {
                db.setCurrentUser(phone);
                initializeApp();
            } else {
                alert('Mobile number or password incorrect.');
            }
        }
        // [END] 6. JS: handleLogin()
            
        function handleLogout() {
            db.logoutUser();
            // Reload the page to clear state and go back to auth
            location.search = ''; // Clear URL params like ?ref=
        }
        
        // --- 3. Dynamic Data Rendering ---
        
        function renderDynamicData(user, appSettings) {
            if (!user) return;
            
            // Home Page
            document.querySelector('#page-home .balance-amount').innerText = `৳ ${user.balance.toFixed(2)}`;
            document.querySelector('#page-home .quick-stats .stat-card:nth-child(1) .value').innerText = user.pendingWithdraw;
            document.querySelector('#page-home .quick-stats .stat-card:nth-child(2) .value').innerText = user.pendingDeposit;
            document.querySelector('#page-home .quick-stats .stat-card:nth-child(3) .value').innerText = `৳ ${user.todayIncome.toFixed(2)}`;
            document.querySelector('#page-home .quick-stats .stat-card:nth-child(4) .value').innerText = `৳ ${user.totalBonus.toFixed(2)}`;
            
            // Home Page Verification Prompt
            const promptDiv = document.getElementById('home-verification-prompt');
            const promptText = document.getElementById('prompt-text');
            const promptBtn = document.getElementById('prompt-action-btn');

            if (user.verificationStatus === 'unverified') {
                promptText.innerText = 'আপনার অ্যাকাউন্ট ভেরিফাই করুন –';
                promptBtn.innerText = 'ভেরিফাই';
                promptBtn.style.backgroundColor = 'var(--primary-yellow)';
                promptBtn.style.display = 'block';
                promptBtn.onclick = (e) => { e.preventDefault(); showVerificationModal(user); };
                promptDiv.style.display = 'flex';
                promptDiv.style.background = '#fffbeb';
                promptDiv.style.color = '#b45309';
            } else if (user.verificationStatus === 'processing') {
                promptText.innerText = 'Verification in progress – ২৪ ঘন্টা অপেক্ষা করুন';
                promptBtn.style.display = 'none';
                promptDiv.style.display = 'flex';
                promptDiv.style.background = '#eff6ff';
                promptDiv.style.color = 'var(--primary-blue)';
            } else if (user.verificationStatus === 'verified') {
                promptDiv.style.display = 'none';
            }

            // Render recent transactions on Home page
            renderHomeTransactions(user);

            // Profile Page
            document.querySelector('#page-profile .profile-header .name').innerText = user.name;
            document.querySelector('#page-profile .setting-item span').innerText = user.phone;
            const statusEl = document.querySelector('#page-profile .profile-header .status');
            const verificationBanner = document.querySelector('#page-profile .verification-banner');
            
            if (user.verificationStatus === 'verified') {
                statusEl.innerHTML = `<i class="fa-solid fa-check-circle" style="color: var(--primary-green);"></i> Verified`;
                statusEl.style.color = 'var(--primary-green)';
                verificationBanner.style.display = 'none';
            } else if (user.verificationStatus === 'processing') {
                statusEl.innerHTML = `<i class="fa-solid fa-hourglass-half" style="color: var(--primary-blue);"></i> Processing`;
                statusEl.style.color = 'var(--primary-blue)';
                verificationBanner.style.display = 'none';
            } else { // unverified
                statusEl.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> Unverified`;
                statusEl.style.color = 'var(--primary-yellow)';
                const charge = appSettings.verificationCharge;
                verificationBanner.innerHTML = `
                    <div class="title">
                        <span>Your Account is Not Verified!</span>
                        <i class="fa-solid fa-shield-halved"></i>
                    </div>
                    <div class="action">
                        <span><i class="fa-solid fa-triangle-exclamation"></i> Deposit ৳${charge} Account/PIN</span>
                        <a href="#" class="btn-verify" onclick="showPage('page-deposit')">Deposit ৳${charge} to Verify</a>
                    </div>`;
                verificationBanner.style.display = 'block';
            }
            
            // [START] 7. JS: Refer Page (Render new UI)
            renderReferralPage(user, appSettings);
            // [END] 7. JS: Refer Page
            
            // Withdraw Page
            document.querySelector('#page-withdraw .balance-info .amount').innerText = `৳ ${user.balance.toFixed(2)}`;
        }
        
        // --- 4. Feature Restriction ---
        function enforceVerification(verificationStatus) {
            document.querySelectorAll('.restricted-feature').forEach(el => {
                const newEl = el.cloneNode(true);
                el.parentNode.replaceChild(newEl, el);
            });
            
            // Bind original actions
            document.querySelector('#nav-tasks').onclick = () => showPage('page-refer'); 
            document.querySelector('#page-home .balance-actions .btn-primary').onclick = () => showPage('page-withdraw');
            document.querySelectorAll('#page-home .action-item[onclick*="page-tasks"]').forEach(el => {
                el.onclick = () => showPage('page-tasks');
            });
            document.querySelector('#page-home .action-item[onclick*="page-history"]').onclick = () => showPage('page-history');
            document.querySelector('#page-home .action-item[onclick*="page-leaderboard"]').onclick = () => showPage('page-leaderboard');
            
            const isRestricted = (verificationStatus === 'unverified' || verificationStatus === 'processing');
            if (!isRestricted) return; // Verified, no restrictions

            // Apply restrictions
            const restrictedElements = [
                document.querySelector('#nav-tasks'), // Invite
                document.querySelector('#page-home .balance-actions .btn-primary'), // Withdraw
                ...document.querySelectorAll('#page-home .action-item[onclick*="page-tasks"]'), // Tasks
                document.querySelector('#page-home .action-item[onclick*="page-leaderboard"]'), // Leaderboard
            ];
            
            const restrictionHandler = (e) => {
                e.preventDefault();
                e.stopPropagation();
                const message = (verificationStatus === 'processing') 
                    ? 'Verification in progress. Please wait.' 
                    : 'Please verify your account to use this feature.';
                showToast(message);
            };

            restrictedElements.forEach(el => {
                if(el) {
                    el.classList.add('restricted-feature');
                    el.onclick = restrictionHandler;
                }
            });
        }
        
        // --- 5. Event Listeners Setup ---
        
        // [START] 8. JS: setupEventListeners() (Final Version)
        function setupEventListeners() {
            // Auth Handlers (Spec 1, 2)
            const btnSignup = document.getElementById('btn-signup-submit');
            if(btnSignup) btnSignup.onclick = (e) => { e.preventDefault(); handleRegistration(); };
            
            const btnLogin = document.getElementById('btn-login-submit');
            if(btnLogin) btnLogin.onclick = (e) => { e.preventDefault(); handleLogin(); };
            
            // App Handlers
            const btnLogout = document.querySelector('#page-profile .logout-btn');
            if (btnLogout) btnLogout.onclick = (e) => { e.preventDefault(); handleLogout(); };

            const btnDeposit = document.querySelector('#page-deposit .submit-button .btn');
            if(btnDeposit) btnDeposit.onclick = (e) => { e.preventDefault(); processDepositRequest(); };
            
            const btnWithdraw = document.querySelector('#page-withdraw .submit-button .btn');
            if(btnWithdraw) btnWithdraw.onclick = (e) => { e.preventDefault(); processWithdrawRequest(); };
            
            // Referral page buttons are bound dynamically in renderReferralPage()
        }
        // [END] 8. JS: setupEventListeners()

        // --- 6. Dynamic Content Renderers ---
        
        // [START] MODIFIED FUNCTION
        function renderPaymentMethods() {
            const methods = db.getPaymentMethods().filter(m => m.enabled);
            const depositContainer = document.querySelector('#page-deposit .payment-methods');
            const withdrawContainer = document.querySelector('#page-withdraw .payment-methods');
            
            if (!depositContainer || !withdrawContainer) return;
            depositContainer.innerHTML = '';
            withdrawContainer.innerHTML = '';
            
            if (methods.length === 0) {
                const noMethodHtml = '<p style="color: var(--text-light); font-size: 0.9rem;">No payment methods available.</p>';
                depositContainer.innerHTML = noMethodHtml;
                withdrawContainer.innerHTML = noMethodHtml;
                return;
            }

            methods.forEach((method, index) => {
                const logoHtml = (method.logo)
                    ? `<img src="${method.logo}" alt="${method.name}">` 
                    : `<span style="font-size: 0.8rem; font-weight: 600; padding: 10px 0;">${method.name}</span>`;
                const selectedClass = (index === 0) ? 'selected' : ''; 
                
                // [MODIFIED] Create different HTML for deposit and withdraw
                
                // Deposit method HTML (sends destination number)
                // We assume the destination number is stored in 'method.number' from admin panel
                const depositMethodHtml = `
                    <div class="method-card ${selectedClass}" 
                         onclick="selectDepositMethod(this)" 
                         data-method-name="${method.name}"
                         data-method-number="${method.number || ''}">
                        ${logoHtml}
                    </div>
                `;
                depositContainer.innerHTML += depositMethodHtml;
                
                // Withdraw method HTML (uses original simple select)
                const withdrawMethodHtml = `
                    <div class="method-card ${selectedClass}" 
                         onclick="selectPayment(this)" 
                         data-method-name="${method.name}">
                        ${logoHtml}
                    </div>
                `;
                withdrawContainer.innerHTML += withdrawMethodHtml;
            });

            // [NEW] Automatically select the first deposit method to populate the number field
            const firstMethod = depositContainer.querySelector('.method-card');
            if (firstMethod) {
                selectDepositMethod(firstMethod);
            }
            
            // [NEW] Automatically select the first withdraw method
             const firstWithdrawMethod = withdrawContainer.querySelector('.method-card');
            if (firstWithdrawMethod) {
                selectPayment(firstWithdrawMethod);
            }
        }
        // [END] MODIFIED FUNCTION

        // [MODIFIED] renderTasks function to implement new flow
        function renderTasks() {
            const tasks = db.getTasks();
            const user = db.getLoggedInUserData();
            const container = document.querySelector('#page-tasks .task-list');
            
            if(!container || !user) return;
            container.innerHTML = '';

            if (tasks.length === 0) {
                container.innerHTML = '<div class="card"><p style="color: var(--text-light); width: 100%; text-align: center;">No tasks available right now.</p></div>';
                return;
            }

            // Updated styles to match new task types
            const taskStyles = {
                'visit': { icon: 'fa-solid fa-link', color: '#3b82f6' },
                'install': { icon: 'fa-solid fa-download', color: '#8b5cf6' },
                'watch': { icon: 'fa-solid fa-tv', color: '#ec4899' },
                'default': { icon: 'fa-solid fa-puzzle-piece', color: '#f59e0b' }
            };

            tasks.forEach(task => {
                const style = taskStyles[task.type] || taskStyles['default'];
                // Check if user has already submitted this task
                const isSubmitted = user.submittedTasks && user.submittedTasks.includes(task.id);
                
                container.innerHTML += `
                    <div class="card">
                        <div class="icon ${task.type}" style="background: ${style.color};">
                            <i class="${style.icon}"></i>
                        </div>
                        <div class="content">
                            <div class="title">${task.title}</div>
                            <div class="reward">Earn ৳${task.reward.toFixed(2)}</div>
                        </div>
                        <button class="btn-start" 
                                onclick="showTaskDetail('${task.id}')" 
                                ${isSubmitted ? 'disabled' : ''}>
                            ${isSubmitted ? 'Pending' : 'Start'}
                        </button>
                    </div>
                `;
            });
        }
        // [END] MODIFIED renderTasks

        function renderChannels() {
            const channels = db.getChannels();
            const container = document.querySelector('#page-join-channels .channel-list');
            if(!container) return;
            container.innerHTML = '';

            if (channels.length === 0) {
                container.innerHTML = '<div class="card"><p style="color: var(--text-light); width: 100%; text-align: center;">No channels listed.</p></div>';
                return;
            }

            const channelStyles = [
                { icon: 'fa-solid fa-dollar-sign', color: 'var(--primary-blue)' },
                { icon: 'fa-solid fa-check-double', color: 'var(--primary-green)' },
            ];

            channels.forEach((channel, index) => {
                const style = channelStyles[index % channelStyles.length]; 
                container.innerHTML += `
                    <div class="card">
                        <div class="icon" style="background: ${style.color};">
                            <i class="${style.icon}"></i>
                        </div>
                        <div class="content">
                            <div class="title">${channel.name}</div>
                            <div class="subtitle">Click to join</div>
                        </div>
                        <button class="btn-join" onclick="window.open('${channel.link}', '_blank')">Join</button>
                    </div>
                `;
            });
        }

        // [START] 9. JS: নতুন রেফারেল পেজ রেন্ডারার (আপনার লজিক অনুযায়ী আপডেট করা)
        // [MODIFIED] This function is updated for the new 4-point logic.
        function renderReferralPage(user, appSettings) {
            const baseUrl = "https://smartpaywallet.vercel.app/register?ref=";
            const userCode = user.referralCode; 
            
            const codeBox = document.getElementById('referral-code-box');
            const linkContainer = document.getElementById('referral-link-container');
            
            if (!codeBox || !linkContainer) return; // Exit if page elements aren't ready

            if (!userCode) {
                codeBox.innerHTML = "No code found";
                linkContainer.innerHTML = "No link found";
                return;
            }
            
            const fullLink = baseUrl + userCode;
            const shareText = `Join ${appSettings.appName} & Earn Rewards! ${fullLink}`;

            // Spec 8.A: Show Referral Code
            codeBox.innerText = userCode;

            // Spec 8.B & 8.C: Show Shareable Link & Buttons
            // [MODIFIED] Added icon to Copy button as requested
            linkContainer.innerHTML = `
                <div class="referral-link-box" style="margin-bottom: 12px;">
                    <input type="text" value="${fullLink}" readonly>
                    <button onclick="copyToClipboard('${fullLink}', 'Link Copied!')" style="display: flex; align-items: center; gap: 6px;">
                        <i class="fa-regular fa-copy"></i>Copy
                    </button>
                </div>
                
                <div class="share-icons" style="padding: 0; justify-content: flex-start; gap: 16px;">
                    <a href="https://api.whatsapp.com/send?text=${encodeURIComponent(shareText)}" target="_blank" class="share-icon" title="Share on WhatsApp">
                        <i class="fab fa-whatsapp" style="width: 40px; height: 40px; font-size: 1.5rem; background: #25D366;"></i>
                    </a>
                    <a href="https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(fullLink)}" target="_blank" class="share-icon" title="Share on Facebook">
                        <i class="fab fa-facebook" style="width: 40px; height: 40px; font-size: 1.5rem; background: #1877F2;"></i>
                    </a>
                    <a href="https://t.me/share/url?url=${encodeURIComponent(fullLink)}&text=${encodeURIComponent(shareText)}" target="_blank" class="share-icon" title="Share on Telegram">
                        <i class="fab fa-telegram" style="width: 40px; height: 40px; font-size: 1.5rem; background: #0088cc;"></i>
                    </a>
                    <a href="fb-messenger://share/?link=${encodeURIComponent(fullLink)}" target="_blank" class="share-icon" title="Share on Messenger">
                        <i class="fab fa-facebook-messenger" style="width: 40px; height: 40px; font-size: 1.5rem; background: #00B2FF;"></i>
                    </a>
                </div>
            `;
            
            // --- [NEW LOGIC] Calculate Stats based on Verification Status ---
            const allUsers = db.getUsers();
            const referredUserPhones = user.referredUsers || [];
            
            let totalVerified = 0;
            let totalProcessing = 0;
            let totalIncome = 0.0;
            const referralHistoryDetails = [];

            referredUserPhones.forEach(phone => {
                const referredUser = allUsers.find(u => u.phone === phone);
                if (!referredUser) return;

                if (referredUser.verificationStatus === 'verified') {
                    totalVerified++;
                    // Note: Bonus is added to balance in admin_approveVerification()
                    // We calculate the total income here for display
                    totalIncome += appSettings.referralBonus; 
                    referralHistoryDetails.push({
                        name: referredUser.name,
                        phone: referredUser.phone,
                        status: 'Verified',
                        earned: appSettings.referralBonus
                    });
                } else {
                    // Includes 'unverified' and 'processing'
                    totalProcessing++;
                    referralHistoryDetails.push({
                        name: referredUser.name,
                        phone: referredUser.phone,
                        status: 'Pending',
                        earned: 0
                    });
                }
            });

            // 1. Update Stats Dashboard (3 cards)
            document.getElementById('referral-stats-count').innerText = totalVerified;
            document.getElementById('referral-stats-income').innerText = `৳ ${totalIncome.toFixed(2)}`;
            document.getElementById('referral-stats-processing').innerText = totalProcessing;
            
            // 2. Render Referral History List
            const historyContainer = document.getElementById('referral-history-list');
            historyContainer.innerHTML = '<div class="section-title" style="padding: 0 0 10px 0;">Referral History</div>'; // Reset title
            
            if (referralHistoryDetails.length === 0) {
                historyContainer.innerHTML += `
                    <div class="list-item" style="opacity: 0.7;">
                        <div class="content">
                            <div class="title" style="font-weight: 500;">No invites yet</div>
                            <div class="subtitle">Share your link to get started!</div>
                        </div>
                    </div>`;
            } else {
                // Show list, most recent first (simulated by reversing the array)
                referralHistoryDetails.reverse().forEach((item, i) => {
                    const statusClass = item.status === 'Verified' ? 'successful' : 'pending';
                    const earnedText = item.status === 'Verified' ? `+ ৳${item.earned.toFixed(2)}` : 'No Earning';
                    
                    historyContainer.innerHTML += `
                    <div class="list-item">
                        <div class="icon"><img src="https://i.pravatar.cc/50?img=${i+10}" alt="Avatar"></div>
                        <div class="content">
                            <div class="title">${item.name || 'Referred User'}</div>
                            <div class="subtitle">ID: ${item.phone.slice(0, 5)}...${item.phone.slice(-3)}</div>
                        </div>
                        <div style="text-align: right;">
                            <div class="status ${statusClass}">${item.status}</div>
                            <div class="amount" style="font-size: 0.9rem; color: ${item.status === 'Verified' ? 'var(--primary-green)' : 'var(--text-light)'};">
                                ${earnedText}
                            </div>
                        </div>
                    </div>`;
                });
            }
        }
        // [END] 9. JS: নতুন রেফারেল পেজ রেন্ডারার
        
        // --- 7. Helper Functions (Copy, Auto-Fill) ---
        
        // [START] 10. JS: অটো-ফিল ফাংশন (Spec 3)
        // This function captures the ?ref=CODE from the URL
        function handleReferralAutoFill() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const refCode = urlParams.get('ref');

                // If a ref code exists in the URL
                if (refCode && refCode.trim() !== "") {
                    const referralInput = document.getElementById('reg-referral');
                    if (referralInput) {
                        // Set the value in the registration form
                        referralInput.value = refCode;
                        // Disable the field so the user can't change it
                        referralInput.disabled = true; 
                        console.log(`Referral code ${refCode} auto-filled.`);
                        
                        // Automatically show the registration page
                        showAuthPage('page-create-account');
                    }
                }
            } catch (e) {
                console.error("Error handling auto-fill:", e);
            }
        }
        // [END] 10. JS: অটো-ফিল ফাংশন

        // Helper function to copy text to clipboard
        function copyToClipboard(text, message) {
             if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    showToast(message || 'Copied!');
                }).catch(err => console.error('Clipboard copy failed:', err));
            } else {
                // Fallback for older browsers
                const textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showToast(message || 'Copied!');
                } catch (err) {
                    console.error('Fallback copy failed:', err);
                }
                document.body.removeChild(textArea);
            }
        }
        
        
        // --- 8. Core App Logic (Transactions, History) ---
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-GB', { 
                day: '2-digit', month: '2-digit', year: 'numeric',
                hour: '2-digit', minute: '2-digit'
            }).replace(',', ' ');
        }
        
        function createHistoryListItem(t) {
            const isDeposit = t.type === 'Deposit';
            const iconClass = isDeposit ? 'deposit' : 'withdraw';
            const icon = isDeposit ? '<i class="fa-solid fa-arrow-down"></i>' : '<i class="fa-solid fa-arrow-up"></i>';
            const statusClass = t.status.toLowerCase();
            const txnLabel = isDeposit ? 'Sender' : 'Recipient';
            const txnId = (t.txid && t.txid !== 'N/A') ? `TXN ID: ${t.txid}` : '';
            
            // [MODIFIED] Check if it's a deposit to show destination number
            const destinationHtml = (isDeposit && t.destinationNumber) 
                ? `<br><span style="font-size: 0.75rem; color: #a0aec0;">To: ${t.destinationNumber}</span>`
                : '';

            return `
                <div class="list-item">
                    <div class="icon ${iconClass}">${icon}</div>
                    <div class="content">
                        <div class="title">
                            ${t.type} - ৳ ${t.amount.toFixed(2)} 
                        </div>
                        <div class="subtitle">
                            ${txnLabel}: ${t.number} / ${t.method}
                            <br>
                            <span style="font-size: 0.75rem; color: var(--text-light);">${txnId}</span>
                            ${destinationHtml}
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div class="amount" style="color: ${isDeposit ? 'var(--primary-green)' : 'var(--primary-blue)'}">
                            ৳ ${t.amount.toFixed(2)}
                        </div>
                        <div class="status ${statusClass}">
                            ${t.status}
                        </div>
                        <div class="subtitle" style="font-size: 0.7rem; margin-top: 2px;">
                            ${formatDate(t.date)}
                        </div>
                    </div>
                </div>`;
        }
        
        function renderHomeTransactions(user) {
            const container = document.getElementById('recent-transactions-home');
            if(!container) return;
            
            if (user.transactions && user.transactions.length > 0) {
                container.innerHTML = '';
                const recent = user.transactions
                                 .sort((a, b) => new Date(b.date) - new Date(a.date))
                                 .slice(0, 3); 
                recent.forEach(t => {
                    container.innerHTML += createHistoryListItem(t);
                });
            } else {
                 container.innerHTML = `
                    <div class="list-item">
                        <div class="icon deposit"><i class="fa-solid fa-arrow-up"></i></div>
                        <div class="content">
                            <div class="title">No transactions yet</div>
                            <div class="subtitle">Make a deposit to get started</div>
                        </div>
                    </div>`;
            }
        }

        function renderHistoryPage(user, filter = 'all') {
            const container = document.getElementById('full-history-list');
            if(!container) return;
            
            const allTransactions = (user.transactions || []).sort((a, b) => new Date(b.date) - new Date(a.date));
            let filteredTransactions = (filter === 'all') ? allTransactions : allTransactions.filter(t => t.type === filter);
            
            container.innerHTML = '';

            if (filteredTransactions.length === 0) {
                container.innerHTML = `<div style="text-align: center; color: var(--text-light); padding: 20px;">No ${filter === 'all' ? '' : filter} transactions found.</div>`;
                return;
            }
            filteredTransactions.forEach(t => {
                container.innerHTML += createHistoryListItem(t);
            });
        }

        // [START] MODIFIED FUNCTION
        function processDepositRequest() {
            let user = db.getLoggedInUserData();
            if (!user) return;
            
            const amount = document.getElementById('deposit-amount').value;
            const senderNumber = document.getElementById('deposit-sender-number').value;
            const txid = document.getElementById('deposit-txid').value;
            const selectedMethodEl = document.querySelector('#page-deposit .method-card.selected');
            const methodName = selectedMethodEl ? selectedMethodEl.dataset.methodName : null;
            
            // [NEW] Read the destination number
            const destinationNumber = document.getElementById('deposit-destination-number').value;
            
            // [MODIFIED] Updated validation
            if (!amount || !senderNumber || !txid) return showErrorToast('Please fill all fields.');
            if (!destinationNumber) return showErrorToast('Center number is missing. Select a method.');
            if (!methodName) return showErrorToast('Please select a payment method.');
            if (senderNumber.length !== 11 || !/^\d+$/.test(senderNumber)) return showErrorToast('Sender Mobile Number must be 11 digits.');
            
            const newDeposit = {
                id: `TXID-${Date.now()}`,
                type: 'Deposit',
                amount: parseFloat(amount),
                number: senderNumber, // Sender's number
                destinationNumber: destinationNumber, // [NEW] Admin's number
                txid: txid,
                date: new Date().toISOString(),
                status: 'pending',
                method: methodName,
                note: 'Deposit request sent.',
            };
            
            db.savePendingDeposits([newDeposit, ...db.getPendingDeposits()]);
            
            user = db.getLoggedInUserData(); // Re-fetch
            db.updateLoggedInUserData({ 
                pendingDeposit: (user.pendingDeposit || 0) + 1,
                transactions: [newDeposit, ...user.transactions]
            });
            
            showSuccessToast('Deposit Request Sent!');
            setTimeout(() => {
                initializeApp();
                showPage('page-home');
            }, 1000);
        }
        // [END] MODIFIED FUNCTION

        function processWithdrawRequest() {
            let user = db.getLoggedInUserData();
            if (!user) return;

            const amount = document.getElementById('withdraw-amount').value;
            const receiverNumber = document.getElementById('withdraw-receiver-number').value;
            const selectedMethodEl = document.querySelector('#page-withdraw .method-card.selected');
            const methodName = selectedMethodEl ? selectedMethodEl.dataset.methodName : null;

            if (!amount || !receiverNumber) return showErrorToast('Please fill all fields.');
            if (!methodName) return showErrorToast('Please select a payment method.');
            if (receiverNumber.length !== 11 || !/^\d+$/.test(receiverNumber)) return showErrorToast('Receiver Account Number must be 11 digits.');
            
            const amountToWithdraw = parseFloat(amount);
            if (amountToWithdraw <= 0) return showErrorToast('Amount must be greater than zero.');
            if (amountToWithdraw > user.balance) return showErrorToast('Insufficient balance.');
            
            const newWithdrawal = {
                id: `WID-${Date.now()}`,
                type: 'Withdraw',
                amount: amountToWithdraw,
                number: receiverNumber,
                txid: 'N/A',
                date: new Date().toISOString(),
                status: 'pending',
                method: methodName,
                note: 'Withdrawal request sent.',
            };

            db.savePendingWithdrawals([newWithdrawal, ...db.getPendingWithdrawals()]);
            
            user = db.getLoggedInUserData(); // Re-fetch
            db.updateLoggedInUserData({ 
                pendingWithdraw: (user.pendingWithdraw || 0) + 1,
                balance: user.balance - amountToWithdraw,
                transactions: [newWithdrawal, ...user.transactions]
            });

            showSuccessToast('Withdrawal Request Sent!');
            setTimeout(() => {
                initializeApp();
                showPage('page-home');
            }, 1000);
        }
        
        // --- 9. Verification Modal Logic ---
        
        function showVerificationModal(user) {
            const settings = db.getAppSettings();
            const charge = settings.verificationCharge;
            
            const modal = document.getElementById('verification-confirmation-modal');
            modal.innerHTML = `
                <h3>অ্যাকাউন্ট ভেরিফিকেশন</h3>
                <div class="detail-item">
                    <span>আপনার বর্তমান ব্যালেন্স:</span>
                    <span id="modal-current-balance">৳ ${user.balance.toFixed(2)}</span>
                </div>
                <div class="detail-item">
                    <span>ভেরিফিকেশন ফি:</span>
                    <span style="color: var(--primary-red); font-weight: 700;">৳ ${charge.toFixed(2)}</span>
                </div>
                <p style="font-size: 0.9rem; color: var(--text-light); text-align: center; margin-top: 16px;">
                    নিশ্চিত করতে ক্লিক করুন আপনার অ্যাকাউন্ট ভেরিফাই করার জন্য।
                </p>
                <div class="modal-actions">
                    <button class="btn btn-outline" id="cancel-verification-btn">Cancel</button>
                    <button class="btn btn-primary" id="confirm-verification-btn">Confirm Verification</button>
                </div>`;

            modal.classList.add('show');
            document.getElementById('modal-overlay').style.display = 'block';
            
            document.getElementById('confirm-verification-btn').onclick = () => handleConfirmVerification(user);
            document.getElementById('cancel-verification-btn').onclick = hideVerificationModal;
            document.getElementById('modal-overlay').onclick = hideVerificationModal;
        }

        function hideVerificationModal() {
            document.getElementById('verification-confirmation-modal').classList.remove('show');
            document.getElementById('modal-overlay').style.display = 'none';
        }
        
        function handleConfirmVerification(user) {
            const settings = db.getAppSettings(); 
            const charge = settings.verificationCharge; 
            
            if (user.balance >= charge) { 
                db.updateLoggedInUserData({ 
                    verificationStatus: 'processing' // Send to admin for approval
                });
                
                hideVerificationModal();
                showSuccessToast('Verification request submitted. Please wait for admin approval.');
                initializeApp(); // Refresh UI
            } else {
                hideVerificationModal();
                showErrorToast('পর্যাপ্ত ব্যালেন্স নেই। দয়া করে ব্যালেন্স যোগ করুন।');
            }
        }
        
        
        // --- 10. Notification Rendering ---
        
        function getUserNotifications(userPhone) {
            const allNotifications = db.getNotifications();
            const readIds = db.getReadNotifications();
            const userSpecific = allNotifications.filter(n => n.target === 'all' || n.target === userPhone);
            return userSpecific.map(n => ({
                ...n,
                status: readIds.includes(n.id) ? 'read' : 'unread'
            })).sort((a, b) => new Date(b.date) - new Date(a.date));
        }

        function renderNotificationBadge() {
            const user = db.getLoggedInUserData();
            if (!user) return;
            const notifications = getUserNotifications(user.phone);
            const unreadCount = notifications.filter(n => n.status === 'unread').length;
            const badge = document.querySelector('.bottom-nav .notification-badge');
            
            if (badge) {
                badge.innerText = unreadCount;
                badge.style.display = (unreadCount > 0) ? 'grid' : 'none';
            }
        }
        
        function createNotificationItem(notification) {
            const iconHtml = '<div class="icon info"><i class="fa-solid fa-bullhorn"></i></div>';
            const datePart = new Date(notification.date).toLocaleDateString('en-GB', { day: '2-digit', month: 'short' });
            return `
                <div class="card">
                    ${iconHtml}
                    <div class="content">
                        <div class="title" style="font-weight: ${notification.status === 'unread' ? '600' : '500'};">
                            ${notification.title}
                        </div>
                        <div class="subtitle">${notification.message}</div>
                    </div>
                    <div class="time">${datePart}</div>
                </div>`;
        }

        function renderNotificationPage() {
            const user = db.getLoggedInUserData();
            if (!user) return;
            const notifications = getUserNotifications(user.phone);
            const container = document.querySelector('#page-notifications .notification-list');
            if(!container) return;
            
            container.innerHTML = '';
            if (notifications.length === 0) {
                container.innerHTML = '<div class="card"><div class="content"><div class="title">No notifications yet.</div></div></div>';
                return;
            }
            notifications.forEach(notif => container.innerHTML += createNotificationItem(notif));
        }
        
        function markNotificationsAsRead() {
            const user = db.getLoggedInUserData();
            if (!user) return;
            const notifications = getUserNotifications(user.phone);
            const unreadIds = notifications.filter(n => n.status === 'unread').map(n => n.id);
            if (unreadIds.length > 0) {
                db.saveReadNotifications([...new Set([...db.getReadNotifications(), ...unreadIds])]);
                renderNotificationBadge();
            }
        }
        
        // --- [NEW] 11. Task Page Logic ---
        
        function showTaskDetail(taskId) {
            const task = db.getTasks().find(t => t.id === taskId);
            if (!task) {
                showErrorToast('Task not found.');
                return;
            }
            
            // Populate the page
            document.getElementById('task-detail-title').innerText = task.title;
            document.getElementById('task-detail-instructions').innerText = task.instructions;
            document.getElementById('task-detail-reward').innerText = `Reward: ৳ ${task.reward.toFixed(2)}`;
            
            // Set the "Visit" button action
            const visitBtn = document.getElementById('task-detail-visit-btn');
            visitBtn.onclick = () => window.open(task.link, '_blank');
            if(task.type === 'install') {
                visitBtn.innerHTML = '<i class="fa-solid fa-download"></i> Install App';
            } else if (task.type === 'watch') {
                visitBtn.innerHTML = '<i class="fa-solid fa-play"></i> Watch Now';
            } else {
                visitBtn.innerHTML = '<i class="fa-solid fa-arrow-up-right-from-square"></i> Visit Link / Join';
            }

            // Set the correct proof submission box
            const proofBoxContainer = document.getElementById('task-detail-proof-box');
            if (task.type === 'install') {
                // Image 2: App Install Task (needs screenshot upload)
                proofBoxContainer.innerHTML = `
                    <label>Proof Submission Box (Upload Screenshot)</label>
                    <input type="file" id="task-proof-input" accept="image/*" class="form-group">
                `;
            } else {
                // Image 1 (visit) & 3 (watch ad) both need a link
                let placeholder = (task.type === 'watch') ? 'Paste Source Link Back' : 'Paste Verizable Link Back';
                proofBoxContainer.innerHTML = `
                    <label>Proof Submission Box (Submit Link)</label>
                    <input type="text" id="task-proof-input" placeholder="${placeholder}" class="form-group">
                `;
            }
            
            // Set the "Submit" button action
            document.getElementById('task-detail-submit-btn').onclick = () => submitTaskProof(task.id);
            
            // Show the page
            showPage('page-task-detail');
        }
        
        // [FIX START] Esta função foi totalmente reescrita para corrigir o bug.
        // Agora, ela envia a submissão para a fila de pendentes do admin ('smartpay_pendingTasks').
        function submitTaskProof(taskId) {
            const task = db.getTasks().find(t => t.id === taskId);
            const proofInput = document.getElementById('task-proof-input');
            if (!task || !proofInput) return;

            let user = db.getLoggedInUserData();
            if (!user) return showErrorToast('User not found. Please log in.');

            // Esta função interna contém a lógica para salvar a submissão.
            // É chamada após a prova (texto ou imagem) ser processada.
            const processSubmission = (proofData) => {
                // Pega os dados do usuário novamente para garantir que estão atualizados
                let currentUser = db.getLoggedInUserData();
                if (!currentUser) return;

                // 1. Cria o objeto de submissão para o painel do admin
                const submission = {
                    id: `sub-${Date.now()}`, // ID de submissão único
                    taskId: task.id,
                    taskTitle: task.title,
                    reward: task.reward,
                    userPhone: currentUser.phone,
                    date: new Date().toISOString(),
                    proof: proofData, // Isso é o link (string) ou os dados da imagem em base64
                    status: 'pending'
                };

                // 2. Obtém as tarefas pendentes existentes, adiciona esta
                const pending = db.getPendingTaskSubmissions();
                pending.push(submission);
                db.savePendingTaskSubmissions(pending); // <-- ESTA É A CORREÇÃO CRÍTICA

                // 3. Atualiza os dados locais do usuário para mostrar 'Pending'
                if (!currentUser.submittedTasks) {
                    currentUser.submittedTasks = [];
                }
                currentUser.submittedTasks.push(task.id);
                db.updateLoggedInUserData({ submittedTasks: currentUser.submittedTasks });

                // 4. Fornece feedback e redireciona
                showSuccessToast('Task submitted for review!');
                console.log(`Task ${task.id} submitted by ${currentUser.phone}. Added to smartpay_pendingTasks.`);
                showPage('page-tasks');
            };

            // --- Lida com diferentes tipos de prova ---

            if (task.type === 'install') {
                // Tarefa de Instalação de App (precisa de upload de screenshot)
                if (!proofInput.files || proofInput.files.length === 0) {
                    return showErrorToast('Please upload a screenshot as proof.');
                }
                
                // Converte a imagem para base64 para armazenar no localStorage
                const reader = new FileReader();
                reader.onloadend = () => {
                    // reader.result contém a string base64 (ex: "data:image/png;base64,...")
                    processSubmission(reader.result); 
                };
                reader.onerror = () => {
                    showErrorToast('Failed to read image file.');
                };
                reader.readAsDataURL(proofInput.files[0]);

            } else {
                // Tarefas de Visita ou Assistir (ambas precisam de um link)
                const proofLink = proofInput.value.trim();
                if (!proofLink) {
                    return showErrorToast('Please paste the proof link.');
                }
                // Validação de link simples
                if (!proofLink.startsWith('http://') && !proofLink.startsWith('https://') && !proofLink.includes('.')) {
                     return showErrorToast('Please enter a valid link (e.g., https://...)');
                }
                
                // Processa com o link de texto como prova
                processSubmission(proofLink);
            }
        }
        // [FIX END] A função corrigida termina aqui.

        // --- [NEW] 12. Leaderboard Rendering ---
        function renderLeaderboard() {
            const topEarnersContainer = document.querySelector('#page-leaderboard .top-earners');
            const listContainer = document.querySelector('#page-leaderboard .leaderboard-list');
            if (!topEarnersContainer || !listContainer) return;
            
            topEarnersContainer.innerHTML = '';
            listContainer.innerHTML = '';
            
            const users = db.getUsers();
            if (!users || users.length === 0) {
                listContainer.innerHTML = '<div style="text-align: center; color: var(--text-light); padding: 20px;">No users found.</div>';
                return;
            }
            
            // Sort users by balance, descending
            const sortedUsers = users.sort((a, b) => (b.balance || 0) - (a.balance || 0));
            
            const top3 = sortedUsers.slice(0, 3);
            const rest = sortedUsers.slice(3, 20); // Get next users up to 20

            // Define ranks and styles
            const ranks = [
                { rank: 1, class: 'rank-1', crown: 'fa-solid fa-crown', color: '#f59e0b', size: '70px' },
                { rank: 2, class: 'rank-2', crown: 'fa-solid fa-crown', color: '#a0aec0', size: '60px' },
                { rank: 3, class: 'rank-3', crown: 'fa-solid fa-crown', color: '#cd7f32', size: '60px' }
            ];
            
            // Find the rank 1, 2, 3 users
            const rank1User = top3[0];
            const rank2User = top3[1];
            const rank3User = top3[2];
            
            // Render Top 3 in the correct visual order (2, 1, 3)
            
            // Rank 2
            if (rank2User) {
                topEarnersContainer.innerHTML += `
                    <div class="earner-card rank-2">
                        <i class="fa-solid fa-crown crown"></i>
                        <img src="https://i.pravatar.cc/50?img=${rank2User.phone.slice(-1)}" alt="Avatar" style="border-color: #a0aec0; width: 60px; height: 60px;">
                        <div class="name">${rank2User.name}</div>
                        <div class="earning">৳${(rank2User.balance || 0).toFixed(2)}</div>
                    </div>
                `;
            }
            
            // Rank 1
            if (rank1User) {
                 topEarnersContainer.innerHTML += `
                    <div class="earner-card rank-1">
                        <i class="fa-solid fa-crown crown"></i>
                        <img src="https://i.pravatar.cc/50?img=${rank1User.phone.slice(-1)}" alt="Avatar" style="border-color: #f59e0b; width: 70px; height: 70px;">
                        <div class="name">${rank1User.name}</div>
                        <div class="earning">৳${(rank1User.balance || 0).toFixed(2)}</div>
                    </div>
                `;
            }
            
            // Rank 3
            if (rank3User) {
                 topEarnersContainer.innerHTML += `
                    <div class="earner-card rank-3">
                        <i class="fa-solid fa-crown crown"></i>
                        <img src="https://i.pravatar.cc/50?img=${rank3User.phone.slice(-1)}" alt="Avatar" style="border-color: #cd7f32; width: 60px; height: 60px;">
                        <div class="name">${rank3User.name}</div>
                        <div class="earning">৳${(rank3User.balance || 0).toFixed(2)}</div>
                    </div>
                `;
            }

            // Render ranks 4-20
            if(rest.length === 0 && top3.length === 0) {
                 listContainer.innerHTML = '<div style="text-align: center; color: var(--text-light); padding: 20px;">No users found.</div>';
            } else if (rest.length === 0) {
                 listContainer.innerHTML = '<div style="text-align: center; color: var(--text-light); padding: 20px 0 0 0;">Only the top 3 are available.</div>';
            } else {
                rest.forEach((user, index) => {
                    const rank = index + 4; // Starts from 4
                    listContainer.innerHTML += `
                        <div class="list-item">
                            <div class="rank-number">${rank}</div>
                            <div class="icon">
                                <img src="https://i.pravatar.cc/50?img=${user.phone.slice(-2)}" alt="Avatar">
                            </div>
                            <div class="details">
                                <div class="name">${user.name}</div>
                                <div class="reward">Phone: 01...${user.phone.slice(-4)}</div>
                            </div>
                            <div class="amount-col">
                                <div class="total">৳${(user.balance || 0).toFixed(2)}</div>
                            </div>
                        </div>
                    `;
                });
            }
        }


        // --- 13. Admin Simulation (Testing) ---
        // These functions can be called from the browser console for testing
        
        function admin_approveDeposit(txid) {
            console.log(`ADMIN: Approving TXID: ${txid}`);
            let deposits = db.getPendingDeposits();
            let users = db.getUsers();
            let deposit = deposits.find(d => d.txid === txid && d.status === 'pending');
            if (!deposit) return console.log('ADMIN: No pending deposit found.');
            
            let user = users.find(u => u.transactions.some(t => t.id === deposit.id));
            if (!user) return console.log('ADMIN: User not found.');

            user.transactions = user.transactions.map(t => (t.id === deposit.id) ? { ...t, status: 'approved', note: 'Deposit verified.' } : t);
            db.savePendingDeposits(deposits.filter(d => d.id !== deposit.id)); 
            user.balance = (user.balance || 0) + parseFloat(deposit.amount);
            user.pendingDeposit = Math.max(0, (user.pendingDeposit || 0) - 1);
            
            db.saveUsers(users);
            console.log(`ADMIN: Approved deposit for ${user.phone}. New balance: ${user.balance}`);
            if (db.getCurrentUser() === user.phone) initializeApp();
        }

        function admin_approveWithdrawal(withdrawalId) {
            console.log(`ADMIN: Approving Withdrawal ID: ${withdrawalId}`);
            let users = db.getUsers();
            let withdrawals = db.getPendingWithdrawals();
            let user = users.find(u => u.transactions.some(t => t.id === withdrawalId && t.status === 'pending'));
            if (!user) return console.log('ADMIN: No pending withdrawal found.');

            user.transactions = user.transactions.map(t => (t.id === withdrawalId) ? { ...t, status: 'successful', note: 'Payment processed.' } : t);
            user.pendingWithdraw = Math.max(0, (user.pendingWithdraw || 0) - 1);
            db.savePendingWithdrawals(withdrawals.filter(w => w.id !== withdrawalId));
            db.saveUsers(users);
            console.log(`ADMIN: Approved withdrawal for ${user.phone}.`);
            if (db.getCurrentUser() === user.phone) initializeApp();
        }
        
        // [START] **** এই ফাংশনটি সম্পূর্ণ আপডেট করা হয়েছে (আপনার সমাধান) ****
        // এটি এখন রেফারারের ব্যালেন্স আপডেট করে এবং রিয়েল-টাইম UI রিফ্রেশ করে
        function admin_approveVerification(phone) { // 'phone' হলো User B (যিনি ভেরিফাই হচ্ছেন) এর ফোন নম্বর
            let users = db.getUsers();
            let userUpdated = false;
            const settings = db.getAppSettings();
            const charge = settings.verificationCharge;
            let referrerPhone = null; // রেফারারের ফোন নম্বর রাখার জন্য
            let referrerCode = null; // রেফারারের কোড রাখার জন্য

            // ধাপ ১: User B-কে খুঁজে বের করা এবং ভেরিফাই করা
            users = users.map(u => {
                if (u.phone === phone && u.verificationStatus === 'processing' && u.balance >= charge) {
                    u.balance -= charge; 
                    u.verificationStatus = 'verified';
                    userUpdated = true;
                    if (u.referredBy) {
                        referrerCode = u.referredBy; // রেফারারের কোডটি সেভ করি
                    }
                    console.log(`ADMIN: Verification approved for ${phone}. Charge deducted.`);
                }
                return u;
            });

            // ধাপ ২: User A (রেফারার)-কে খুঁজে বের করা এবং ব্যালেন্স আপডেট করা
            if (userUpdated && referrerCode) {
                const bonus = settings.referralBonus;
                let referrerFound = false;
                
                console.log(`ADMIN: Trying to find referrer with code: ${referrerCode} (Type: ${typeof referrerCode})`);

                users = users.map(u => {
                    // [মূল সমাধান] এখানে টাইপ-সেফ তুলনা (type-safe comparison) যোগ করা হয়েছে
                    if (u.referralCode && u.referralCode.toString() === referrerCode.toString()) {
                        
                        console.log(`ADMIN: Referrer ${u.phone} found! Awarding bonus.`);
                        
                        // এখানে User A-এর ব্যালেন্স এবং টোটাল বোনাস আপডেট করা হচ্ছে
                        u.balance = (u.balance || 0) + bonus;
                        u.totalBonus = (u.totalBonus || 0) + bonus; // হোম পেজের 'Total Bonus' কার্ডের জন্য
                        
                        referrerPhone = u.phone; // রিয়েল-টাইম আপডেটের জন্য User A-এর ফোন নম্বর সেভ করি
                        referrerFound = true;
                        console.log(`ADMIN: Awarded ৳${bonus} bonus to referrer ${u.phone}. New balance: ${u.balance}`);
                    }
                    return u;
                });
                
                if (!referrerFound) console.log(`ADMIN: Referrer code ${referrerCode} found, but no matching referrer user account.`);
            }

            // ধাপ ৩: ডেটাবেস সেভ করা এবং রিয়েল-টাইম UI রিফ্রেশ
            if (userUpdated) {
                db.saveUsers(users); // সমস্ত পরিবর্তন (User A এবং B উভয়ের) সেভ করা হলো
                
                const currentUser = db.getCurrentUser();
                
                // [রিয়েল-টাইম আপডেট]
                // যদি বর্তমান লগইন করা ইউজার User B (phone) হন অথবা User A (referrerPhone) হন
                if (currentUser === phone || currentUser === referrerPhone) {
                    initializeApp(); // UI রিফ্রেশ করি (পেজ রিলোড ছাড়াই)
                }
            } else {
                console.log(`ADMIN: No user found with phone ${phone} in 'processing' state or insufficient balance.`);
            }
        }
        // [END] **** আপডেটেড ফাংশন শেষ ****
        
        function admin_clearAllData() {
            localStorage.clear();
            console.log('ADMIN: All data cleared. Reloading.');
            location.reload();
        }

        // --- Initial Setup ---
        // Run the app initialization code when the page is fully loaded
        document.addEventListener('DOMContentLoaded', initializeApp);

    </script>
    </body>
</html>